# .gitlab-ci.yml - VERSION PERFECTIONN√âE
# Toutes vos corrections appliqu√©es

stages:
  - dependencies    # Installation unique
  - security        # S√©curit√© parall√®le
  - validate_test   # Validation + tests
  - build           # Builds Docker parall√®les
  - deploy          # D√©ploiement
  - cleanup         # Nettoyage

# =============================================
# Variables Globales
# =============================================

variables:
  DOCKER_TLS_CERTDIR: ""
  NODE_VERSION: "20"
  POSTGRES_VERSION: "15"
  NEXT_TELEMETRY_DISABLED: "1"

  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"

  COMMIT_TAG: "sha-${CI_COMMIT_SHORT_SHA}"

# =============================================
# Cache Configuration - CORRIG√â (Votre suggestion 1)
# =============================================

cache:
  key: "npm-${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
  policy: pull-push

# =============================================
# Job Templates avec timeouts
# =============================================

.docker_build_template: &docker_build_template
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker info
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  tags:
    - windows
    - local
  timeout: 15 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

.node_template: &node_template
  image: node:${NODE_VERSION}
  variables:
    NPM_CONFIG_PREFER_OFFLINE: "true"
    NPM_CONFIG_AUDIT: "false"
  before_script:
    - node --version
    - npm --version
  tags:
    - windows
    - local
  timeout: 10 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# =============================================
# DEPENDENCIES STAGE - 1 JOB
# =============================================

install_all_deps:
  stage: dependencies
  <<: *node_template
  script:
    - echo "üì¶ Installing ALL dependencies..."

    # NETTOYAGE CONDITIONNEL WINDOWS - CORRIG√â (Votre suggestion 2)
    - |
      if (Test-Path "client/node_modules") {
        Remove-Item -Recurse -Force client/node_modules -ErrorAction SilentlyContinue
        Write-Host "‚úÖ Cleaned client/node_modules"
      }
    - |
      if (Test-Path "backend/node_modules") {
        Remove-Item -Recurse -Force backend/node_modules -ErrorAction SilentlyContinue
        Write-Host "‚úÖ Cleaned backend/node_modules"
      }

    # Installation frontend
    - cd client
    - npm ci --no-audit --prefer-offline --silent
    - Write-Host "‚úÖ Frontend dependencies installed"
    - cd ..

    # Installation backend
    - cd backend
    - npm ci --no-audit --prefer-offline --silent
    - npx prisma generate --silent
    - Write-Host "‚úÖ Backend dependencies installed"
    - cd ..

    - Write-Host "üéâ All dependencies successfully installed"
  cache:
    key: "npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - client/node_modules/
      - backend/node_modules/
    policy: pull-push
  # R√àGLES SIMPLIFI√âES (Votre suggestion 3)
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# =============================================
# SECURITY STAGE - 2 JOBS EN PARALL√àLE
# =============================================

security_scan:
  stage: security
  image: node:${NODE_VERSION}
  script:
    - Write-Host "üîí Running comprehensive security scan..."
    - |
      if (Test-Path "client/package.json") {
        cd client
        Write-Host "üì¶ Scanning frontend dependencies for vulnerabilities..."
        npm audit --audit-level moderate --production || {
          Write-Host "‚ö†Ô∏è Frontend vulnerabilities detected - check logs above"
          exit 0
        }
        cd ..
      }
    - |
      if (Test-Path "backend/package.json") {
        cd backend
        Write-Host "üì¶ Scanning backend dependencies for vulnerabilities..."
        npm audit --audit-level moderate --production || {
          Write-Host "‚ö†Ô∏è Backend vulnerabilities detected - check logs above"
          exit 0
        }
        cd ..
      }
    - Write-Host "‚úÖ Security scan completed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  tags:
    - windows
    - local
  timeout: 5 minutes

database_schema_validation:
  stage: security
  image: node:${NODE_VERSION}
  services:
    - postgres:${POSTGRES_VERSION}
  variables:
    POSTGRES_DB: test_employeedb
    POSTGRES_USER: tester
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: "postgresql://tester:test_password@postgres:5432/test_employeedb"
  script:
    - cd backend
    - Write-Host "üóÑÔ∏è Validating database schema with PostgreSQL..."
    - npx prisma validate --silent
    - Write-Host "üîÑ Resetting test database..."
    - npx prisma migrate reset --force --skip-seed
    - Write-Host "üìä Applying migrations..."
    - npx prisma migrate deploy
    - Write-Host "‚úÖ Database schema validation successful"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  tags:
    - windows
    - local
  timeout: 5 minutes
  retry:
    max: 2

# =============================================
# VALIDATE + TEST STAGE - 3 JOBS OPTIMIS√âS
# =============================================

validate_frontend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üîç Validating frontend build..."
    - cd client

    # V√©rification cache + fallback
    - |
      if (!(Test-Path "node_modules")) {
        Write-Host "‚ö†Ô∏è Cache missing - reinstalling frontend dependencies..."
        npm ci --no-audit --prefer-offline --silent
      }

    - Write-Host "üèóÔ∏è Building frontend application..."
    - npm run build
    - Write-Host "‚úÖ Frontend validation passed successfully"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 8 minutes

validate_backend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üîç Validating backend build..."
    - cd backend

    # V√©rification cache + fallback
    - |
      if (!(Test-Path "node_modules")) {
        Write-Host "‚ö†Ô∏è Cache missing - reinstalling backend dependencies..."
        npm ci --no-audit --prefer-offline --silent
      }

    - Write-Host "üèóÔ∏è Building backend application..."
    - $buildScript = npm run | Select-String "build"
    - |
      if ($buildScript) {
        npm run build --silent
        Write-Host "‚úÖ Backend build completed"
      } else {
        Write-Host "‚ÑπÔ∏è No build script found - skipping build"
      }
    - Write-Host "‚úÖ Backend validation passed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 5 minutes

run_all_tests:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üß™ Running comprehensive test suite..."

    # Frontend tests avec logs am√©lior√©s
    - cd client
    - $testScript = npm run | Select-String "test"
    - |
      if ($testScript) {
        Write-Host "üéØ Running frontend tests..."
        npm test -- --watchAll=false --passWithNoTests --silent || {
          Write-Host "‚ùå Frontend tests failed - check test output above"
          exit 1
        }
        Write-Host "‚úÖ Frontend tests passed"
      } else {
        Write-Host "‚ÑπÔ∏è No frontend test script found"
      }
    - cd ..

    # Backend tests avec logs am√©lior√©s
    - cd backend
    - $hasJest = (Test-Path "jest.config.js") -or (Test-Path "jest.config.cjs") -or (Test-Path "jest.config.ts")
    - |
      if ($hasJest) {
        Write-Host "üéØ Running backend tests..."
        npm run test -- --silent --passWithNoTests || {
          Write-Host "‚ùå Backend tests failed - check test output above"
          exit 1
        }
        Write-Host "‚úÖ Backend tests passed"
      } else {
        Write-Host "‚ÑπÔ∏è No Jest configuration found"
      }
    - cd ..

    # Code quality checks
    - Write-Host "üìã Running code quality checks..."
    - |
      if (Test-Path "client/package.json") {
        cd client
        $hasLint = npm run | Select-String "lint"
        if ($hasLint) {
          npm run lint --silent || Write-Host "‚ö†Ô∏è Frontend linting issues found"
        }
        cd ..
      }
    - |
      if (Test-Path "backend/package.json") {
        cd backend
        $hasLint = npm run | Select-String "lint"
        if ($hasLint) {
          npm run lint --silent || Write-Host "‚ö†Ô∏è Backend linting issues found"
        }
        cd ..
      }

    - Write-Host "üéâ All tests completed successfully"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: false
  timeout: 10 minutes
  retry:
    max: 1
    when:
      - runner_system_failure

# =============================================
# BUILD STAGE - 3 JOBS AVEC CACHE DOCKER SIMPLIFI√â (Votre suggestion 4)
# =============================================

build_frontend:
  <<: *docker_build_template
  stage: build
  script:
    - Write-Host "üèóÔ∏è Building frontend with Docker cache..."
    - |
      docker build \
        --cache-from $FRONTEND_IMAGE:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        -t $FRONTEND_IMAGE:$COMMIT_TAG \
        -t $FRONTEND_IMAGE:latest \
        ./client
    - Write-Host "üì§ Pushing frontend image..."
    - docker push $FRONTEND_IMAGE:$COMMIT_TAG
    - docker push $FRONTEND_IMAGE:latest
    - Write-Host "‚úÖ Frontend built with cache"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_backend:
  <<: *docker_build_template
  stage: build
  script:
    - Write-Host "üèóÔ∏è Building backend with Docker cache..."
    - |
      docker build \
        --cache-from $BACKEND_IMAGE:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        -t $BACKEND_IMAGE:$COMMIT_TAG \
        -t $BACKEND_IMAGE:latest \
        ./backend
    - Write-Host "üì§ Pushing backend image..."
    - docker push $BACKEND_IMAGE:$COMMIT_TAG
    - docker push $BACKEND_IMAGE:latest
    - Write-Host "‚úÖ Backend built with cache"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_database:
  <<: *docker_build_template
  stage: build
  script:
    - Write-Host "üèóÔ∏è Building database image..."
    - docker build -t $DB_IMAGE:$COMMIT_TAG ./db
    - docker push $DB_IMAGE:$COMMIT_TAG
    - Write-Host "‚úÖ Database built successfully"
  # CORRECTION TYPO (Votre suggestion 6)
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# =============================================
# TEST DATABASE IMAGE
# =============================================

test_database_image:
  stage: validate_test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - Write-Host "üóÑÔ∏è Testing database image build..."
    - docker build -t $DB_IMAGE:test ./db
    - Write-Host "‚úÖ Database image test successful"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  tags:
    - windows
    - local
  timeout: 5 minutes

# =============================================
# DEPLOY + CLEANUP
# =============================================

deploy_staging:
  stage: deploy
  image: alpine:latest
  environment:
    name: staging
    url: https://staging.ems-platform.com
  before_script:
    - apk add --no-cache openssh-client
  script:
    - Write-Host "üöÄ Deploying to staging environment..."
    - |
      ssh -o StrictHostKeyChecking=no $STAGING_DEPLOY_USER@$STAGING_DEPLOY_SERVER "
        cd $STAGING_DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build frontend backend &&
        echo '‚úÖ Staging deployment completed'"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
  tags:
    - windows
    - local
  timeout: 10 minutes

deploy_production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://ems-platform.com
  before_script:
    - apk add --no-cache openssh-client curl
  script:
    - Write-Host "üöÄ Deploying to production environment..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "
        cd $DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build &&
        echo '‚úÖ Production deployment completed'"
    - Write-Host "üîÑ Running production health checks..."
    - sleep 10
    - curl -f https://ems-platform.com/api/health || {
        Write-Host "‚ùå Health check failed - deployment might have issues"
        exit 1
      }
    - Write-Host "‚úÖ Production deployment verified"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
  tags:
    - windows
    - local
  timeout: 15 minutes

cleanup_docker:
  stage: cleanup
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - Write-Host "üßπ Cleaning up Docker resources..."
    - docker system prune -f --filter "until=24h"
    - Write-Host "üìä Docker disk usage after cleanup:"
    - docker system df
    - Write-Host "‚úÖ Cleanup completed"
  tags:
    - windows
    - local
  when: always
  allow_failure: true
  timeout: 5 minutes

# =============================================
# Workflow Configuration
# =============================================

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'