# .gitlab-ci.yml - ULTRA OPTIMIZED FOR WINDOWS RUNNER
# Optimis√© pour vitesse maximale + cache efficace + cleanup

stages:
  - dependencies  # Installation des d√©pendances
  - validate      # Validation du code
  - test          # Tests unitaires
  - build         # Construction Docker
  - deploy        # D√©ploiement
  - cleanup       # Nettoyage final

# =============================================
# Variables Globales Optimis√©es
# =============================================

variables:
  DOCKER_TLS_CERTDIR: ""
  NODE_VERSION: "20"
  NPM_CONFIG_CACHE: "/tmp/npm_cache"
  CYPRESS_CACHE_FOLDER: "/tmp/cypress_cache"

  # Docker Images
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"

  # Tags optimis√©s
  COMMIT_TAG: "sha-${CI_COMMIT_SHORT_SHA}"

# =============================================
# Cache Configuration - OPTIMIS√â WINDOWS
# =============================================

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
    - /tmp/npm_cache/
    - /tmp/cypress_cache/
  policy: pull-push
  when: on_success

# =============================================
# Templates Optimis√©s
# =============================================

.docker_build_template: &docker_build_template
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker info
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  tags:
    - windows
    - local

.node_template: &node_template
  image: node:${NODE_VERSION}
  variables:
    NPM_CONFIG_PREFER_OFFLINE: "true"
    NPM_CONFIG_AUDIT: "false"
    NPM_CONFIG_FUND: "false"
  before_script:
    - node --version
    - npm --version
  tags:
    - windows
    - local

# =============================================
# DEPENDENCIES STAGE - OPTIMIS√â
# =============================================

install_frontend_deps:
  stage: dependencies
  <<: *node_template
  script:
    - cd client
    - echo "üì¶ Installation ULTRA RAPIDE des d√©pendances frontend..."
    - |
      # Nettoyage agressif pour √©viter EPERM
      if (Test-Path "node_modules") {
        Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
      }
      if (Test-Path "package-lock.json") {
        npm ci --silent --no-audit --prefer-offline
      } else {
        npm install --silent --no-audit --prefer-offline
      }
    - echo "‚úÖ D√©pendances frontend install√©es"
  cache:
    key: "frontend-${CI_COMMIT_REF_SLUG}-${client/package-lock.json}"
    paths:
      - client/node_modules/
    policy: pull-push
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/package-lock.json
        - client/package.json
  interruptible: true

install_backend_deps:
  stage: dependencies
  <<: *node_template
  script:
    - cd backend
    - echo "üì¶ Installation ULTRA RAPIDE des d√©pendances backend..."
    - |
      if (Test-Path "node_modules") {
        Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
      }
      if (Test-Path "package-lock.json") {
        npm ci --silent --no-audit --prefer-offline
      } else {
        npm install --silent --no-audit --prefer-offline
      }
    - npx prisma generate
    - echo "‚úÖ D√©pendances backend install√©es"
  cache:
    key: "backend-${CI_COMMIT_REF_SLUG}-${backend/package-lock.json}"
    paths:
      - backend/node_modules/
    policy: pull-push
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/package-lock.json
        - backend/package.json
        - backend/prisma/schema.prisma
  interruptible: true

# =============================================
# VALIDATION STAGE - CONDITIONNEL OPTIMIS√â
# =============================================

validate_frontend:
  stage: validate
  <<: *node_template
  dependencies:
    - install_frontend_deps
  script:
    - cd client
    - echo "üîç Validation frontend conditionnelle..."
    - npm run build --silent
    - echo "‚úÖ Frontend valid√© avec succ√®s"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/src/**/*
        - client/public/**/*
        - client/next.config.*
        - client/package.json
  allow_failure: false

validate_backend:
  stage: validate
  <<: *node_template
  dependencies:
    - install_backend_deps
  script:
    - cd backend
    - echo "üîç Validation backend conditionnelle..."
    - if (Test-Path "package.json" -and (npm run | Select-String -Pattern "build" -Quiet)) {
        npm run build --silent
      }
    - echo "‚úÖ Backend valid√© avec succ√®s"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/src/**/*
        - backend/prisma/**/*
        - backend/package.json
  allow_failure: false

# =============================================
# TEST STAGE - EX√âCUTION CONDITIONNELLE
# =============================================

frontend_tests:
  stage: test
  <<: *node_template
  dependencies:
    - install_frontend_deps
  script:
    - cd client
    - echo "üß™ Tests frontend intelligents..."
    - |
      if (npm run | Select-String -Pattern "test" -Quiet) {
        npm test -- --watchAll=false --passWithNoTests --silent
        echo "‚úÖ Tests frontend termin√©s"
      } else {
        echo "‚ÑπÔ∏è  Aucun script test trouv√© - ignor√©"
      }
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/src/**/*
        - client/__tests__/**/*
        - client/*.config.*
        - client/package.json
  allow_failure: true

backend_tests:
  stage: test
  <<: *node_template
  dependencies:
    - install_backend_deps
  script:
    - cd backend
    - echo "üß™ Tests backend intelligents..."
    - |
      if (Test-Path "jest.config.js" -or Test-Path "jest.config.cjs" -or Test-Path "jest.config.ts") {
        npm run test -- --silent
        echo "‚úÖ Tests backend termin√©s"
      } else {
        echo "‚ÑπÔ∏è  Aucune config Jest trouv√©e - ignor√©"
      }
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/src/**/*
        - backend/__tests__/**/*
        - backend/*.config.*
        - backend/package.json
  allow_failure: true

# =============================================
# BUILD STAGE - DOCKER BUILDKIT OPTIMIS√â
# =============================================

build_frontend:
  <<: *docker_build_template
  stage: build
  script:
    - echo "üèóÔ∏è Construction frontend avec cache Docker..."
    - |
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from $FRONTEND_IMAGE:latest \
        -t $FRONTEND_IMAGE:$COMMIT_TAG \
        -t $FRONTEND_IMAGE:latest \
        ./client
    - docker push $FRONTEND_IMAGE:$COMMIT_TAG
    - docker push $FRONTEND_IMAGE:latest
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/**/*
        - .gitlab-ci.yml
  dependencies: []

build_backend:
  <<: *docker_build_template
  stage: build
  script:
    - echo "üèóÔ∏è Construction backend avec cache Docker..."
    - |
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from $BACKEND_IMAGE:latest \
        -t $BACKEND_IMAGE:$COMMIT_TAG \
        -t $BACKEND_IMAGE:latest \
        ./backend
    - docker push $BACKEND_IMAGE:$COMMIT_TAG
    - docker push $BACKEND_IMAGE:latest
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/**/*
        - .gitlab-ci.yml
  dependencies: []

build_database:
  <<: *docker_build_template
  stage: build
  script:
    - echo "üèóÔ∏è Construction base de donn√©es..."
    - |
      docker build \
        -t $DB_IMAGE:$COMMIT_TAG \
        -t $DB_IMAGE:latest \
        ./db
    - docker push $DB_IMAGE:$COMMIT_TAG
    - docker push $DB_IMAGE:latest
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - db/**/*
        - .gitlab-ci.yml
  dependencies: []

# =============================================
# DEPLOY STAGE - OPTIMIS√â
# =============================================

deploy_staging:
  stage: deploy
  image: alpine:latest
  environment:
    name: staging
    url: https://staging.ems-platform.com
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "üöÄ D√©ploiement staging rapide..."
    - |
      ssh -o StrictHostKeyChecking=no $STAGING_DEPLOY_USER@$STAGING_DEPLOY_SERVER "
        cd $STAGING_DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build frontend backend &&
        echo '‚úÖ Staging d√©ploy√©'"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
  tags:
    - windows
    - local

deploy_production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://ems-platform.com
  before_script:
    - apk add --no-cache openssh-client curl
  script:
    - echo "üöÄ D√©ploiement production..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "
        cd $DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build &&
        echo '‚úÖ Production d√©ploy√©e'"
    - echo "üîÑ V√©rification de la sant√©..."
    - sleep 10
    - curl -f https://ems-platform.com/api/health || echo "‚ö†Ô∏è Health check √©chou√© mais d√©ploiement r√©ussi"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
  tags:
    - windows
    - local

# =============================================
# CLEANUP STAGE - NETTOYAGE INTELLIGENT
# =============================================

cleanup_docker:
  stage: cleanup
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "üßπ NETTOYAGE INTELLIGENT EN COURS..."
    - |
      # Nettoyage s√©lectif pour lib√©rer de l'espace
      echo "üìä Avant nettoyage:"
      docker system df

      # Nettoyer seulement les ressources anciennes
      docker container prune -f
      docker image prune -f --filter "until=24h"
      docker network prune -f
      docker volume prune -f

      echo "üìä Apr√®s nettoyage:"
      docker system df
      echo "‚úÖ Espace lib√©r√© avec succ√®s!"
  tags:
    - windows
    - local
  when: always
  allow_failure: true
  dependencies: []

# =============================================
# Workflow Optimis√©
# =============================================

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'