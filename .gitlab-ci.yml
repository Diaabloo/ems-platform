stages:
  - test
  - build
  - push
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  CACHE_DIR: "$CI_PROJECT_DIR/.cache"
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"
  SHORT_SHA: "${CI_COMMIT_SHA:0:8}"
  COMMIT_TAG: "sha-${SHORT_SHA}-${CI_PIPELINE_ID}"
  VERSION_TAG: "v${CI_PIPELINE_ID}"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
    - $CACHE_DIR

# ----------- TEST JOBS -----------
test_frontend:
  stage: test
  image: node:20
  script:
    - cd client
    - npm ci
    - npm run lint || true
    - npm test || true
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

test_backend:
  stage: test
  image: node:20
  script:
    - cd backend
    - npm ci
    - npm run lint || true
    - npm test || true
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

test_db:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Testing $DB_IMAGE:$COMMIT_TAG"
    - docker run -d --name db_test -e POSTGRES_PASSWORD=testpassword $DB_IMAGE:$COMMIT_TAG
    - sleep 10
    - docker exec db_test psql -U postgres -c "SELECT 1"
    - echo "Database test passed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/Dockerfile
        - db/**/*
  needs: ["build_db"]

# ----------- BUILD JOBS -----------
build_frontend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Building $FRONTEND_IMAGE:$COMMIT_TAG"
    - docker build -t "$FRONTEND_IMAGE:$COMMIT_TAG" ./client
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_backend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Building $BACKEND_IMAGE:$COMMIT_TAG"
    - docker build -t "$BACKEND_IMAGE:$COMMIT_TAG" ./backend
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_db:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Building $DB_IMAGE:$COMMIT_TAG"
    - docker build -t "$DB_IMAGE:$COMMIT_TAG" ./db
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/Dockerfile
        - db/**/*

# ----------- PUSH JOBS -----------
push_frontend:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Checking Docker Hub credentials..."
    - if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ]; then echo "ERROR: DOCKERHUB_USERNAME or DOCKERHUB_TOKEN missing!"; exit 1; fi
    - echo "$DOCKERHUB_TOKEN" > docker_token.txt
    - docker login -u "$DOCKERHUB_USERNAME" --password-stdin < docker_token.txt
    - rm docker_token.txt
    - echo "Pushing $FRONTEND_IMAGE:$COMMIT_TAG"
    - docker push "$FRONTEND_IMAGE:$COMMIT_TAG"
    - docker tag "$FRONTEND_IMAGE:$COMMIT_TAG" "$FRONTEND_IMAGE:$CI_COMMIT_REF_NAME"
    - docker push "$FRONTEND_IMAGE:$CI_COMMIT_REF_NAME"
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then echo "Tagging $FRONTEND_IMAGE as $VERSION_TAG and latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$FRONTEND_IMAGE:$COMMIT_TAG" "$FRONTEND_IMAGE:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$FRONTEND_IMAGE:$COMMIT_TAG" "$FRONTEND_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$FRONTEND_IMAGE:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$FRONTEND_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then echo "Tagging $FRONTEND_IMAGE as latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker tag "$FRONTEND_IMAGE:$COMMIT_TAG" "$FRONTEND_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker push "$FRONTEND_IMAGE:latest"; fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  needs: ["build_frontend"]

push_backend:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Checking Docker Hub credentials..."
    - if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ]; then echo "ERROR: DOCKERHUB_USERNAME or DOCKERHUB_TOKEN missing!"; exit 1; fi
    - echo "$DOCKERHUB_TOKEN" > docker_token.txt
    - docker login -u "$DOCKERHUB_USERNAME" --password-stdin < docker_token.txt
    - rm docker_token.txt
    - echo "Pushing $BACKEND_IMAGE:$COMMIT_TAG"
    - docker push "$BACKEND_IMAGE:$COMMIT_TAG"
    - docker tag "$BACKEND_IMAGE:$COMMIT_TAG" "$BACKEND_IMAGE:$CI_COMMIT_REF_NAME"
    - docker push "$BACKEND_IMAGE:$CI_COMMIT_REF_NAME"
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then echo "Tagging $BACKEND_IMAGE as $VERSION_TAG and latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$BACKEND_IMAGE:$COMMIT_TAG" "$BACKEND_IMAGE:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$BACKEND_IMAGE:$COMMIT_TAG" "$BACKEND_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$BACKEND_IMAGE:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$BACKEND_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then echo "Tagging $BACKEND_IMAGE as latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker tag "$BACKEND_IMAGE:$COMMIT_TAG" "$BACKEND_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker push "$BACKEND_IMAGE:latest"; fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  needs: ["build_backend"]

push_db:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Checking Docker Hub credentials..."
    - if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ]; then echo "ERROR: DOCKERHUB_USERNAME or DOCKERHUB_TOKEN missing!"; exit 1; fi
    - echo "$DOCKERHUB_TOKEN" > docker_token.txt
    - docker login -u "$DOCKERHUB_USERNAME" --password-stdin < docker_token.txt
    - rm docker_token.txt
    - echo "Pushing $DB_IMAGE:$COMMIT_TAG"
    - docker push "$DB_IMAGE:$COMMIT_TAG"
    - docker tag "$DB_IMAGE:$COMMIT_TAG" "$DB_IMAGE:$CI_COMMIT_REF_NAME"
    - docker push "$DB_IMAGE:$CI_COMMIT_REF_NAME"
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then echo "Tagging $DB_IMAGE as $VERSION_TAG and latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$DB_IMAGE:$COMMIT_TAG" "$DB_IMAGE:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$DB_IMAGE:$COMMIT_TAG" "$DB_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$DB_IMAGE:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$DB_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then echo "Tagging $DB_IMAGE as latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker tag "$DB_IMAGE:$COMMIT_TAG" "$DB_IMAGE:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker push "$DB_IMAGE:latest"; fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/Dockerfile
        - db/**/*
  needs: ["build_db"]

# ----------- DEPLOY JOB -----------
deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to production server..."
    - apk add --no-cache openssh-client
    - if [ -z "$DEPLOY_USER" ] || [ -z "$DEPLOY_HOST" ]; then echo "ERROR: DEPLOY_USER or DEPLOY_HOST missing!"; exit 1; fi
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "
        cd /path/to/project &&
        export FRONTEND_IMAGE=$FRONTEND_IMAGE:latest &&
        export BACKEND_IMAGE=$BACKEND_IMAGE:latest &&
        export DB_IMAGE=$DB_IMAGE:latest &&
        docker-compose -f docker-compose.prod.yml pull &&
        docker-compose -f docker-compose.prod.yml up -d
      "
  environment: production
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual

# ----------- DEBUG JOB -----------
debug_variables:
  stage: test
  image: alpine:latest
  script:
    - echo "DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME"
    - echo "DOCKERHUB_TOKEN is set? $([ -z "$DOCKERHUB_TOKEN" ] && echo 'NO' || echo 'YES')"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
      when: manual