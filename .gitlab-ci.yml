# .gitlab-ci.yml - VERSION PROFESSIONNELLE PERN STACK
# Optimis√© pour Windows + Docker-in-Docker avec migration Linux facile

# =============================================
# CONFIGURATION GLOBALE
# =============================================

stages:
  - dependencies    # Installation des d√©pendances
  - security        # Audit s√©curit√© et validation
  - validate_test   # Validation et tests
  - build           # Construction des images Docker
  - deploy          # D√©ploiement
  - clean           # Nettoyage

variables:
  # Configuration Docker
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: "1"  # BuildKit pour meilleures performances

  # Versions
  NODE_VERSION: "20"
  POSTGRES_VERSION: "15"

  # Optimisations
  NEXT_TELEMETRY_DISABLED: "1"
  NPM_CONFIG_PREFER_OFFLINE: "true"
  NPM_CONFIG_AUDIT: "false"

  # Noms des images Docker
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"
  COMMIT_TAG: "sha-${CI_COMMIT_SHORT_SHA}"

# =============================================
# CACHE CONFIGURATION - NE JAMAIS SUPPRIMER node_modules
# =============================================

cache:
  key: "npm-${CI_COMMIT_REF_SLUG}"
  paths:
    - frontend/node_modules/
    - backend/node_modules/
  policy: pull-push
  untracked: false
  when: on_success

# =============================================
# TEMPLATES R√âUTILISABLES
# =============================================

.docker_template: &docker_template
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker info
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  tags:
    - windows
    - local
  # Note migration Linux: remplacer tags par -> tags: [docker, linux]

.node_template: &node_template
  image: node:${NODE_VERSION}
  before_script:
    - node --version
    - npm --version
  tags:
    - windows
    - local
  # Note migration Linux: remplacer tags par -> tags: [docker, linux]

# =============================================
# STAGE DEPENDENCIES - Installation s√©par√©e par service
# =============================================

install_frontend_deps:
  stage: dependencies
  <<: *node_template
  script:
    - Write-Host "üì¶ Installation des d√©pendances Frontend..."
    - cd frontend
    - npm install --prefer-offline --no-audit
    - Write-Host "‚úÖ D√©pendances Frontend install√©es"
  cache:
    key: "npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - frontend/node_modules/
    policy: pull-push
  rules:
    - changes:
        - frontend/package.json
        - frontend/package-lock.json
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

install_backend_deps:
  stage: dependencies
  <<: *node_template
  script:
    - Write-Host "üì¶ Installation des d√©pendances Backend..."
    - cd backend
    - npm install --prefer-offline --no-audit
    - npx prisma generate --no-hints
    - Write-Host "‚úÖ D√©pendances Backend install√©es"
  cache:
    key: "npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/node_modules/
    policy: pull-push
  rules:
    - changes:
        - backend/package.json
        - backend/package-lock.json
        - backend/prisma/schema.prisma
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

# =============================================
# STAGE SECURITY - Audit et validation
# =============================================

audit_frontend:
  stage: security
  <<: *node_template
  script:
    - Write-Host "üîí Audit de s√©curit√© Frontend..."
    - cd frontend
    - npm audit --audit-level high --production
    - Write-Host "‚úÖ Audit Frontend compl√©t√©"
  rules:
    - changes:
        - frontend/package.json
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 5 minutes

audit_backend:
  stage: security
  <<: *node_template
  script:
    - Write-Host "üîí Audit de s√©curit√© Backend..."
    - cd backend
    - npm audit --audit-level high --production
    - Write-Host "‚úÖ Audit Backend compl√©t√©"
  rules:
    - changes:
        - backend/package.json
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 5 minutes

validate_prisma_schema:
  stage: security
  <<: *node_template
  script:
    - Write-Host "üóÑÔ∏è Validation du sch√©ma Prisma..."
    - cd backend
    - npx prisma validate
    - Write-Host "‚úÖ Sch√©ma Prisma valid√©"
  rules:
    - changes:
        - backend/prisma/schema.prisma
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 3 minutes

# =============================================
# STAGE VALIDATE_TEST - Validation et tests parall√®les
# =============================================

validate_frontend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üîç Validation du build Frontend..."
    - cd frontend
    - npm run build
    - Write-Host "‚úÖ Frontend valid√© avec succ√®s"
  rules:
    - changes:
        - frontend/**
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 8 minutes

validate_backend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üîç Validation du build Backend..."
    - cd backend
    - npm run build
    - Write-Host "‚úÖ Backend valid√© avec succ√®s"
  rules:
    - changes:
        - backend/**
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 6 minutes

test_frontend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üß™ Ex√©cution des tests Frontend..."
    - cd frontend
    - |
      # Ex√©cution conditionnelle des tests
      if (Test-Path "package.json") {
        $testScript = npm run | Select-String "test"
        if ($testScript) {
          npm test -- --watchAll=false --passWithNoTests --silent
          Write-Host "‚úÖ Tests Frontend compl√©t√©s"
        } else {
          Write-Host "‚ö†Ô∏è Aucun script de test trouv√© dans Frontend"
        }
      }
  rules:
    - changes:
        - frontend/**
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 8 minutes

test_backend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üß™ Ex√©cution des tests Backend..."
    - cd backend
    - |
      # Ex√©cution conditionnelle des tests
      if (Test-Path "package.json") {
        $hasJest = (Test-Path "jest.config.js") -or (Test-Path "jest.config.cjs") -or (Test-Path "jest.config.ts")
        if ($hasJest) {
          npm run test -- --silent --passWithNoTests
          Write-Host "‚úÖ Tests Backend compl√©t√©s"
        } else {
          Write-Host "‚ö†Ô∏è Aucune configuration Jest trouv√©e dans Backend"
        }
      }
  rules:
    - changes:
        - backend/**
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 8 minutes

# =============================================
# STAGE BUILD - Construction des images Docker
# =============================================

build_frontend_image:
  stage: build
  <<: *docker_template
  script:
    - Write-Host "üèóÔ∏è Construction de l'image Frontend..."
    - docker build -t $FRONTEND_IMAGE:$COMMIT_TAG ./frontend
    - |
      # Push conditionnel - UNIQUEMENT sur main ou tags
      if [[ "$CI_COMMIT_REF_NAME" == "main" || "$CI_COMMIT_TAG" ]]; then
        Write-Host "üöÄ Push de l'image Frontend..."
        docker push $FRONTEND_IMAGE:$COMMIT_TAG
      else
        Write-Host "‚è≠Ô∏è Push ignor√© (branche: $CI_COMMIT_REF_NAME)"
      }
    - Write-Host "‚úÖ Image Frontend construite"
  rules:
    - changes:
        - frontend/**
        - frontend/Dockerfile*
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 15 minutes

build_backend_image:
  stage: build
  <<: *docker_template
  script:
    - Write-Host "üèóÔ∏è Construction de l'image Backend..."
    - docker build -t $BACKEND_IMAGE:$COMMIT_TAG ./backend
    - |
      # Push conditionnel - UNIQUEMENT sur main ou tags
      if [[ "$CI_COMMIT_REF_NAME" == "main" || "$CI_COMMIT_TAG" ]]; then
        Write-Host "üöÄ Push de l'image Backend..."
        docker push $BACKEND_IMAGE:$COMMIT_TAG
      else {
        Write-Host "‚è≠Ô∏è Push ignor√© (branche: $CI_COMMIT_REF_NAME)"
      }
    - Write-Host "‚úÖ Image Backend construite"
  rules:
    - changes:
        - backend/**
        - backend/Dockerfile*
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 15 minutes

build_db_image:
  stage: build
  <<: *docker_template
  script:
    - Write-Host "üèóÔ∏è Construction de l'image Database..."
    - docker build -t $DB_IMAGE:$COMMIT_TAG ./db
    - |
      # Push conditionnel - UNIQUEMENT sur main ou tags
      if [[ "$CI_COMMIT_REF_NAME" == "main" || "$CI_COMMIT_TAG" ]]; then
        Write-Host "üöÄ Push de l'image Database..."
        docker push $DB_IMAGE:$COMMIT_TAG
      else {
        Write-Host "‚è≠Ô∏è Push ignor√© (branche: $CI_COMMIT_REF_NAME)"
      }
    - Write-Host "‚úÖ Image Database construite"
  rules:
    - changes:
        - db/**
        - db/Dockerfile*
    - if: '$CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

# =============================================
# OPTION: Build unique des 3 images (d√©commenter si pr√©f√©r√©)
# =============================================

# build_all_images:
#   stage: build
#   <<: *docker_template
#   script:
#     - Write-Host "üèóÔ∏è Construction group√©e des images..."
#     - docker build -t $FRONTEND_IMAGE:$COMMIT_TAG ./frontend
#     - docker build -t $BACKEND_IMAGE:$COMMIT_TAG ./backend
#     - docker build -t $DB_IMAGE:$COMMIT_TAG ./db
#     - |
#       if [[ "$CI_COMMIT_REF_NAME" == "main" || "$CI_COMMIT_TAG" ]]; then
#         Write-Host "üöÄ Push group√© des images..."
#         docker push $FRONTEND_IMAGE:$COMMIT_TAG
#         docker push $BACKEND_IMAGE:$COMMIT_TAG
#         docker push $DB_IMAGE:$COMMIT_TAG
#       fi
#     - Write-Host "‚úÖ Toutes les images construites"
#   rules:
#     - changes:
#         - frontend/**
#         - backend/**
#         - db/**
#         - Dockerfile*
#     - if: '$CI_COMMIT_REF_NAME == "main"'
#   timeout: 25 minutes
#   # AVANTAGE: Plus simple, moins de jobs
#   # INCONV√âNIENT: Moins visible dans l'UI, rebuild tout m√™me si un seul service change

# =============================================
# STAGE DEPLOY - D√©ploiement
# =============================================

deploy_staging:
  stage: deploy
  image: alpine:latest
  environment:
    name: staging
    url: https://staging.ems-platform.com
  before_script:
    - apk add --no-cache openssh-client
  script:
    - Write-Host "üöÄ D√©ploiement en staging..."
    - |
      ssh -o StrictHostKeyChecking=no $STAGING_DEPLOY_USER@$STAGING_DEPLOY_SERVER "
        cd $STAGING_DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build &&
        echo '‚úÖ Staging d√©ploy√© avec succ√®s'"
    - Write-Host "‚úÖ D√©ploiement staging termin√©"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
  tags:
    - windows
    - local
  timeout: 10 minutes

deploy_production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://ems-platform.com
  before_script:
    - apk add --no-cache openssh-client curl
  script:
    - Write-Host "üöÄ D√©ploiement en production..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "
        cd $DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build &&
        echo '‚úÖ Production d√©ploy√©e avec succ√®s'"
    - Write-Host "üîÑ V√©rification de sant√©..."
    - sleep 10
    - curl -f https://ems-platform.com/api/health || exit 1
    - Write-Host "‚úÖ D√©ploiement production termin√©"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
  tags:
    - windows
    - local
  timeout: 15 minutes

# =============================================
# STAGE CLEAN - Nettoyage l√©ger
# =============================================

cleanup_docker:
  stage: clean
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - Write-Host "üßπ Nettoyage Docker..."
    - docker system prune -f
    - Write-Host "‚úÖ Nettoyage termin√©"
  tags:
    - windows
    - local
  when: always
  allow_failure: true
  timeout: 5 minutes

# =============================================
# CONFIGURATION WORKFLOW
# =============================================

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'

# =============================================
# NOTES MIGRATION LINUX
# =============================================

# Pour migrer vers un runner Linux:
# 1. Changer les tags: [windows, local] -> [docker, linux]
# 2. Option Docker socket (plus rapide que dind):
#    - Supprimer le service docker:24-dind
#    - Ajouter: /var/run/docker.sock:/var/run/docker.sock
#    - Variables: DOCKER_HOST: unix:///var/run/docker.sock
# 3. Adapter les commandes PowerShell vers shell