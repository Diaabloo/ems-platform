stages:
  - test
  - build
  - push
  # - deploy   # (activ√© plus tard)

# ------------------------------------------------------------------
# GLOBAL VARIABLES
# ------------------------------------------------------------------
variables:
  DOCKER_DRIVER: overlay2
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"

# ------------------------------------------------------------------
# COMMON TEMPLATES
# ------------------------------------------------------------------
.build_template: &build_template
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  before_script:
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "main"'

.push_template: &push_template
  stage: push
  image: docker:27
  services:
    - docker:27-dind
  before_script:
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# ------------------------------------------------------------------
# TEST JOBS
# ------------------------------------------------------------------
test_backend:
  stage: test
  image: node:20
  script:
    - cd backend
    - npm install
    - npm test --if-present

test_frontend:
  stage: test
  image: node:20
  script:
    - cd client
    - npm install
    - npm test --if-present

# ------------------------------------------------------------------
# BUILD JOBS
# ------------------------------------------------------------------
build_backend:
  <<: *build_template
  variables:
    IMAGE_NAME: $BACKEND_IMAGE
    BUILD_CONTEXT: "./backend"
  script:
    - echo "üèóÔ∏è Building backend..."
    - docker build -t "$IMAGE_NAME:sha-$CI_COMMIT_SHORT_SHA" "$BUILD_CONTEXT"

build_frontend:
  <<: *build_template
  variables:
    IMAGE_NAME: $FRONTEND_IMAGE
    BUILD_CONTEXT: "./client"
  script:
    - echo "üèóÔ∏è Building frontend..."
    - docker build -t "$IMAGE_NAME:sha-$CI_COMMIT_SHORT_SHA" "$BUILD_CONTEXT"

# ------------------------------------------------------------------
# PUSH JOBS
# ------------------------------------------------------------------
push_backend:
  <<: *push_template
  needs: ["build_backend"]
  script:
    - docker tag "$BACKEND_IMAGE:sha-$CI_COMMIT_SHORT_SHA" "$BACKEND_IMAGE:latest"
    - docker push "$BACKEND_IMAGE:sha-$CI_COMMIT_SHORT_SHA"
    - docker push "$BACKEND_IMAGE:latest"
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        VERSION_TAG="v$CI_PIPELINE_ID"
        docker tag "$BACKEND_IMAGE:sha-$CI_COMMIT_SHORT_SHA" "$BACKEND_IMAGE:$VERSION_TAG"
        docker push "$BACKEND_IMAGE:$VERSION_TAG"
      fi

push_frontend:
  <<: *push_template
  needs: ["build_frontend"]
  script:
    - docker tag "$FRONTEND_IMAGE:sha-$CI_COMMIT_SHORT_SHA" "$FRONTEND_IMAGE:latest"
    - docker push "$FRONTEND_IMAGE:sha-$CI_COMMIT_SHORT_SHA"
    - docker push "$FRONTEND_IMAGE:latest"
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        VERSION_TAG="v$CI_PIPELINE_ID"
        docker tag "$FRONTEND_IMAGE:sha-$CI_COMMIT_SHORT_SHA" "$FRONTEND_IMAGE:$VERSION_TAG"
        docker push "$FRONTEND_IMAGE:$VERSION_TAG"
      fi

# ------------------------------------------------------------------
# DEPLOY (COMMENT√â POUR PLUS TARD)
# ------------------------------------------------------------------
# deploy_prod:
#   stage: deploy
#   script:
#     - echo "üöÄ Deploying to production server..."
#   only:
#     - main
