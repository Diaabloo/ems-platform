# .gitlab-ci.yml - OPTIMIZED VERSION FOR WINDOWS POWERSHELL

# =============================================
# CI/CD Pipeline for Employee Management System
# PERN Stack with Prisma ORM - OPTIMIZED
# =============================================

stages:
  - dependencies  # Dependency installation (parallel)
  - validate      # Code quality, security scans (parallel)
  - test          # Unit tests, integration tests (parallel)
  - build         # Docker image building (parallel)
  - deploy        # Staging and production deployment
  - cleanup       # Cleanup operations

# =============================================
# Global Variables & Configuration
# =============================================

variables:
  DOCKER_TLS_CERTDIR: ""
  NODE_VERSION: "20"
  POSTGRES_VERSION: "15"

  # Docker Images
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"

  # Tags for Docker images
  COMMIT_TAG: "sha-${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_ID}"
  VERSION_TAG: "v${CI_PIPELINE_ID}"

  # Cache configuration
  NPM_CACHE_KEY: "${CI_COMMIT_REF_SLUG}-npm-${CI_COMMIT_SHORT_SHA}"

# =============================================
# Cache Configuration - OPTIMIZED
# =============================================

cache:
  key: "${NPM_CACHE_KEY}"
  paths:
    - client/node_modules/
    - backend/node_modules/
    - .npm/
  policy: pull-push
  when: on_success

# =============================================
# Job Templates
# =============================================

.docker_build_template: &docker_build_template
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker info
    - |
      if [ -z "$DOCKERHUB_TOKEN" ]; then
        echo "‚ùå DOCKERHUB_TOKEN is not set"
        exit 1
      fi
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  tags:
    - windows
    - local

.node_template: &node_template
  image: node:${NODE_VERSION}
  tags:
    - windows
    - local

# =============================================
# DEPENDENCIES STAGE - PowerShell compatible
# =============================================

install_frontend_deps:
  stage: dependencies
  <<: *node_template
  script:
    - cd client
    - |
      # PowerShell compatible dependency check
      if (Test-Path "package-lock.json") {
        $packageLock = Get-Item "package-lock.json"
        $lockFile = Get-Item "../.npm/.lock-file" -ErrorAction SilentlyContinue
        if (-not $lockFile -or $packageLock.LastWriteTime -gt $lockFile.LastWriteTime) {
          echo "üì¶ package-lock.json changed, running npm ci..."
          npm ci --prefer-offline --cache .npm --audit false
        } else {
          echo "üì¶ Using cached node_modules, checking integrity..."
          npm ci --prefer-offline --cache .npm --audit false
          if ($LASTEXITCODE -ne 0) {
            npm install --prefer-offline --cache .npm
          }
        }
      } else {
        echo "üì¶ No package-lock.json, running npm install..."
        npm install --prefer-offline --cache .npm
      }
    - New-Item -ItemType Directory -Force -Path "../.npm"
    - Set-Content -Path "../.npm/.lock-file" -Value "lock"
  cache:
    key: "${NPM_CACHE_KEY}-frontend"
    paths:
      - client/node_modules/
      - client/.npm/
    policy: pull-push
  artifacts:
    paths:
      - client/node_modules/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/package-lock.json
        - client/package.json

install_backend_deps:
  stage: dependencies
  <<: *node_template
  script:
    - cd backend
    - |
      # PowerShell compatible dependency check
      if (Test-Path "package-lock.json") {
        $packageLock = Get-Item "package-lock.json"
        $lockFile = Get-Item "../.npm/.lock-file" -ErrorAction SilentlyContinue
        if (-not $lockFile -or $packageLock.LastWriteTime -gt $lockFile.LastWriteTime) {
          echo "üì¶ package-lock.json changed, running npm ci..."
          npm ci --prefer-offline --cache .npm --audit false
        } else {
          echo "üì¶ Using cached node_modules, checking integrity..."
          npm ci --prefer-offline --cache .npm --audit false
          if ($LASTEXITCODE -ne 0) {
            npm install --prefer-offline --cache .npm
          }
        }
      } else {
        echo "üì¶ No package-lock.json, running npm install..."
        npm install --prefer-offline --cache .npm
      }
    - npx prisma generate
    - New-Item -ItemType Directory -Force -Path "../.npm"
    - Set-Content -Path "../.npm/.lock-file" -Value "lock"
  cache:
    key: "${NPM_CACHE_KEY}-backend"
    paths:
      - backend/node_modules/
      - backend/.npm/
    policy: pull-push
  artifacts:
    paths:
      - backend/node_modules/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/package-lock.json
        - backend/package.json
        - backend/prisma/schema.prisma

# =============================================
# VALIDATION STAGE - PowerShell compatible
# =============================================

validate_frontend:
  stage: validate
  <<: *node_template
  dependencies:
    - install_frontend_deps
  script:
    - cd client
    - echo "üîç Validating frontend..."
    - npm run build
    - echo "‚úÖ Frontend validation successful"
  artifacts:
    paths:
      - client/.next/
    expire_in: 6 hours
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/**/*
        - .gitlab-ci.yml

validate_backend:
  stage: validate
  <<: *node_template
  dependencies:
    - install_backend_deps
  script:
    - cd backend
    - echo "üîç Validating backend..."
    - |
      # PowerShell compatible script checking
      $scripts = npm run
      if ($scripts -like "*build*") {
        npm run build
        echo "‚úÖ Backend build successful"
      }
    - |
      $scripts = npm run
      if ($scripts -like "*lint*") {
        npm run lint
        echo "‚úÖ Backend linting completed"
      }
  artifacts:
    paths:
      - backend/dist/
    expire_in: 6 hours
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/**/*
        - .gitlab-ci.yml

security_audit:
  stage: validate
  <<: *node_template
  script:
    - echo "üîí Running security audit..."
    - |
      # PowerShell compatible security check
      if (Test-Path "client/package-lock.json") {
        $clientLock = Get-Item "client/package-lock.json"
        if ((Get-Date) - $clientLock.LastWriteTime -le (New-TimeSpan -Days 7)) {
          cd client
          npm audit --audit-level high --production
          cd ..
        }
      }
    - |
      if (Test-Path "backend/package-lock.json") {
        $backendLock = Get-Item "backend/package-lock.json"
        if ((Get-Date) - $backendLock.LastWriteTime -le (New-TimeSpan -Days 7)) {
          cd backend
          npm audit --audit-level high --production
          cd ..
        }
      }
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/package-lock.json
        - backend/package-lock.json
    - if: $CI_PIPELINE_SOURCE == "schedule"

# =============================================
# TEST STAGE - PowerShell compatible
# =============================================

frontend_tests:
  stage: test
  <<: *node_template
  dependencies:
    - install_frontend_deps
  script:
    - cd client
    - echo "üß™ Running frontend tests..."
    - |
      $scripts = npm run
      if ($scripts -like "*test*") {
        $testOutput = npm run test -- --dry-run 2>&1
        if ($testOutput -notlike "*Error: no test specified*") {
          npm test -- --coverage --watchAll=false --passWithNoTests
          echo "‚úÖ Frontend tests completed"
        } else {
          echo "‚ö†Ô∏è  Test script exists but has 'no test specified' error"
        }
      } else {
        echo "‚ö†Ô∏è  No test script found, skipping tests"
      }
  artifacts:
    paths:
      - client/coverage/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/src/**/*
        - client/__tests__/**/*
        - client/package.json

backend_tests:
  stage: test
  <<: *node_template
  dependencies:
    - install_backend_deps
  script:
    - cd backend
    - echo "üß™ Running backend tests..."
    - |
      if (Test-Path "jest.config.js" -or Test-Path "jest.config.cjs") {
        npm run test:ci
        echo "‚úÖ Backend tests completed"
      } else {
        echo "‚ö†Ô∏è  No Jest config found, skipping tests"
      }
  artifacts:
    paths:
      - backend/coverage/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/src/**/*
        - backend/__tests__/**/*
        - backend/package.json

database_tests:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - postgres:${POSTGRES_VERSION}
  variables:
    POSTGRES_DB: test_employeedb
    POSTGRES_USER: tester
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: "postgresql://tester:test_password@postgres:5432/test_employeedb"
  script:
    - cd backend
    - npm ci --prefer-offline --cache .npm
    - npx prisma generate
    - echo "üóÑÔ∏è Testing database..."
    - npx prisma validate
    - npx prisma migrate reset --force --skip-seed
    - npx prisma migrate deploy
    - echo "‚úÖ Database tests passed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/prisma/schema.prisma
        - backend/prisma/migrations/**/*
  tags:
    - windows
    - local

# =============================================
# BUILD STAGE - Docker builds (keep as is)
# =============================================

build_frontend:
  <<: *docker_build_template
  stage: build
  script:
    - echo "üèóÔ∏è Building frontend image..."
    - |
      docker build \
        --build-arg BUILD_VERSION=${CI_COMMIT_SHORT_SHA} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        -t $FRONTEND_IMAGE:$COMMIT_TAG \
        -t $FRONTEND_IMAGE:latest \
        ./client
    - echo "üìå Pushing frontend image..."
    - docker push $FRONTEND_IMAGE:$COMMIT_TAG
    - docker push $FRONTEND_IMAGE:latest
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $FRONTEND_IMAGE:$COMMIT_TAG $FRONTEND_IMAGE:$VERSION_TAG
        docker push $FRONTEND_IMAGE:$VERSION_TAG
      fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - client/**/*
        - Dockerfile
        - .dockerignore

build_backend:
  <<: *docker_build_template
  stage: build
  script:
    - echo "üèóÔ∏è Building backend image..."
    - |
      docker build \
        --build-arg BUILD_VERSION=${CI_COMMIT_SHORT_SHA} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        -t $BACKEND_IMAGE:$COMMIT_TAG \
        -t $BACKEND_IMAGE:latest \
        ./backend
    - echo "üìå Pushing backend image..."
    - docker push $BACKEND_IMAGE:$COMMIT_TAG
    - docker push $BACKEND_IMAGE:latest
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $BACKEND_IMAGE:$COMMIT_TAG $BACKEND_IMAGE:$VERSION_TAG
        docker push $BACKEND_IMAGE:$VERSION_TAG
      fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - backend/**/*
        - Dockerfile
        - .dockerignore

build_database:
  <<: *docker_build_template
  stage: build
  script:
    - echo "üèóÔ∏è Building database image..."
    - |
      if (Test-Path "db/employeedb_dump_pg15.sql") {
        echo "‚úÖ SQL file exists"
      } else {
        echo "‚ùå SQL file missing"
        exit 1
      }
    - |
      docker build \
        --build-arg BUILD_VERSION=${CI_COMMIT_SHORT_SHA} \
        -t $DB_IMAGE:$COMMIT_TAG \
        -t $DB_IMAGE:latest \
        ./db
    - echo "üìå Pushing database image..."
    - docker push $DB_IMAGE:$COMMIT_TAG
    - docker push $DB_IMAGE:latest
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $DB_IMAGE:$COMMIT_TAG $DB_IMAGE:$VERSION_TAG
        docker push $DB_IMAGE:$VERSION_TAG
      fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
    - changes:
        - db/**/*

# =============================================
# DEPLOY STAGE
# =============================================

deploy_staging:
  stage: deploy
  image: alpine:latest
  environment:
    name: staging
    url: https://staging.ems-platform.com
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "üöÄ Deploying to staging..."
    - |
      ssh -o StrictHostKeyChecking=no $STAGING_DEPLOY_USER@$STAGING_DEPLOY_SERVER "
        cd $STAGING_DEPLOY_PATH &&
        docker-compose pull frontend backend &&
        docker-compose up -d frontend backend &&
        echo '‚úÖ Staging deployment completed'"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
  tags:
    - windows
    - local

deploy_production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://ems-platform.com
  before_script:
    - apk add --no-cache openssh-client curl
  script:
    - echo "üöÄ Deploying to production..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "
        cd $DEPLOY_PATH &&
        docker-compose pull &&
        docker-compose up -d &&
        docker system prune -f"
    - |
      for i in 1 2 3 4 5; do
        curl -f https://ems-platform.com/api/health && break || sleep 30
      done
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
  tags:
    - windows
    - local

# =============================================
# CLEANUP STAGE
# =============================================

cleanup:
  stage: cleanup
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "üßπ Cleaning up..."
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker system prune -f --filter "until=48h"
  when: on_success
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  tags:
    - windows
    - local

# =============================================
# WORKFLOW CONFIGURATION
# =============================================

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG