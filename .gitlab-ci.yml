stages:
  - test
  - build
  - push
  # - deploy # Disabled for now, to be enabled when ready

variables:
  DOCKER_TLS_CERTDIR: ""
  FRONTEND_IMAGE: "amineelalami/ems-platform:frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform:backend"
  DB_IMAGE: "amineelalami/ems-platform:db"
  CACHE_DIR: "$CI_PROJECT_DIR/.cache"
  TAG: "v${CI_PIPELINE_ID}" # Default tag for main, overridden for dev

# Cache node_modules to speed up test and build jobs
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
    - $CACHE_DIR

# ------------------------
# Test stage: Frontend tests
# ------------------------
test_frontend:
  image: node:20
  stage: test
  script:
    - echo "üîç Running frontend tests..."
    - cd client
    - npm ci
    - npm run lint || true # Run linting, continue if it fails
    - npm test || true     # Run tests, continue if it fails
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ------------------------
# Test stage: Backend tests
# ------------------------
test_backend:
  image: node:20
  stage: test
  script:
    - echo "üîç Running backend tests..."
    - cd backend
    - npm ci
    - npm run lint || true # Run linting, continue if it fails
    - npm test || true     # Run tests, continue if it fails
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ------------------------
# Build stage: Frontend image
# ------------------------
build_frontend:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  script:
    - echo "üèóÔ∏è Building frontend Docker image..."
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHA ./client
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ------------------------
# Build stage: Backend image
# ------------------------
build_backend:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  script:
    - echo "üèóÔ∏è Building backend Docker image..."
    - docker build -t $BACKEND_IMAGE:$CI_COMMIT_SHA ./backend
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ------------------------
# Build stage: Database image
# ------------------------
build_db:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  script:
    - echo "üèóÔ∏è Building database Docker image..."
    - docker build -t $DB_IMAGE:$CI_COMMIT_SHA ./db
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/Dockerfile
        - db/**/*

# ------------------------
# Push stage: Frontend image
# ------------------------
push_frontend:
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  script:
    - echo "üîë Logging in to Docker Hub..."
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "üìå Pushing frontend image..."
    - docker tag $FRONTEND_IMAGE:$CI_COMMIT_SHA $FRONTEND_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_REF_NAME
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        echo "üìå Tagging frontend as v${CI_PIPELINE_ID} for production"
        docker tag $FRONTEND_IMAGE:$CI_COMMIT_SHA $FRONTEND_IMAGE:v${CI_PIPELINE_ID}
        docker push $FRONTEND_IMAGE:v${CI_PIPELINE_ID}
      elif [ "$CI_COMMIT_REF_NAME" = "dev" ]; then
        echo "üìå Tagging frontend as latest for development"
        docker tag $FRONTEND_IMAGE:$CI_COMMIT_SHA $FRONTEND_IMAGE:latest
        docker push $FRONTEND_IMAGE:latest
      fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  variables:
    DOCKERHUB_USERNAME: $DOCKERHUB_USERNAME
    DOCKERHUB_TOKEN: $DOCKERHUB_TOKEN

# ------------------------
# Push stage: Backend image
# ------------------------
push_backend:
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  script:
    - echo "üîë Logging in to Docker Hub..."
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "üìå Pushing backend image..."
    - docker tag $BACKEND_IMAGE:$CI_COMMIT_SHA $BACKEND_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $BACKEND_IMAGE:$CI_COMMIT_REF_NAME
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        echo "üìå Tagging backend as v${CI_PIPELINE_ID} for production"
        docker tag $BACKEND_IMAGE:$CI_COMMIT_SHA $BACKEND_IMAGE:v${CI_PIPELINE_ID}
        docker push $BACKEND_IMAGE:v${CI_PIPELINE_ID}
      elif [ "$CI_COMMIT_REF_NAME" = "dev" ]; then
        echo "üìå Tagging backend as latest for development"
        docker tag $BACKEND_IMAGE:$CI_COMMIT_SHA $BACKEND_IMAGE:latest
        docker push $BACKEND_IMAGE:latest
      fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  variables:
    DOCKERHUB_USERNAME: $DOCKERHUB_USERNAME
    DOCKERHUB_TOKEN: $DOCKERHUB_TOKEN

# ------------------------
# Push stage: Database image
# ------------------------
push_db:
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  script:
    - echo "üîë Logging in to Docker Hub..."
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "üìå Pushing database image..."
    - docker tag $DB_IMAGE:$CI_COMMIT_SHA $DB_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $DB_IMAGE:$CI_COMMIT_REF_NAME
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        echo "üìå Tagging database as v${CI_PIPELINE_ID} for production"
        docker tag $DB_IMAGE:$CI_COMMIT_SHA $DB_IMAGE:v${CI_PIPELINE_ID}
        docker push $DB_IMAGE:v${CI_PIPELINE_ID}
      elif [ "$CI_COMMIT_REF_NAME" = "dev" ]; then
        echo "üìå Tagging database as latest for development"
        docker tag $DB_IMAGE:$CI_COMMIT_SHA $DB_IMAGE:latest
        docker push $DB_IMAGE:latest
      fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/Dockerfile
        - db/**/*
  variables:
    DOCKERHUB_USERNAME: $DOCKERHUB_USERNAME
    DOCKERHUB_TOKEN: $DOCKERHUB_TOKEN

# ------------------------
# Deploy stage: Disabled for now
# ------------------------
# deploy:
#   stage: deploy
#   script:
#     - echo "üöÄ Deploying to production server..."
#     # Example: SSH to server and run docker-compose
#     - ssh user@your-server "cd /path/to/project && TAG=v${CI_PIPELINE_ID} docker-compose -f docker-compose.prod.yml pull && docker-compose -f docker-compose.prod.yml up -d"
#   rules:
#     - if: '$CI_COMMIT_REF_NAME == "main"'
#   environment:
#     name: production
#     url: https://your-production-url.com