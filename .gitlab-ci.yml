stages:
  - test
  - build
  - push
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  CACHE_DIR: "$CI_PROJECT_DIR/.cache"

  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"

  SHORT_SHA: "${CI_COMMIT_SHA:0:8}"
  TIMESTAMP: "$(date +%Y%m%d%H%M%S)"
  COMMIT_TAG: "sha-${CI_COMMIT_SHA:0:8}-${CI_PIPELINE_ID}"
  VERSION_TAG: "v${CI_PIPELINE_ID}"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
    - $CACHE_DIR

# ----------- TEST JOBS -----------
test_frontend:
  stage: test
  image: node:20
  script:
    - cd client
    - npm ci
    - npm run lint || true
    - npm test || true
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

test_backend:
  stage: test
  image: node:20
  script:
    - cd backend
    - npm ci
    - npm run lint || true
    - npm test || true
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ----------- BUILD JOBS -----------
build_frontend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -t $FRONTEND_IMAGE:$COMMIT_TAG ./client
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_backend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -t $BACKEND_IMAGE:$COMMIT_TAG ./backend
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ----------- PUSH JOBS -----------
push_frontend:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Docker Username: '$DOCKERHUB_USERNAME'"
    - echo "Docker Token length: ${#DOCKERHUB_TOKEN}"
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $FRONTEND_IMAGE:$COMMIT_TAG
    - docker tag $FRONTEND_IMAGE:$COMMIT_TAG $FRONTEND_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_REF_NAME
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

push_backend:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $BACKEND_IMAGE:$COMMIT_TAG
    - docker tag $BACKEND_IMAGE:$COMMIT_TAG $BACKEND_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $BACKEND_IMAGE:$CI_COMMIT_REF_NAME
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ----------- DEPLOY JOB -----------
deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - echo "ðŸš€ Deploying to production server..."
    - apk add --no-cache openssh
    - ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
        cd /path/to/project &&
        docker-compose -f docker-compose.prod.yml pull &&
        docker-compose -f docker-compose.prod.yml up -d
      "
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
