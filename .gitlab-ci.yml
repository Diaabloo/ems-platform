stages:
  - test
  - build
  - push
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  CACHE_DIR: "$CI_PROJECT_DIR/.cache"

  # Docker images names
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"

  # Git info tags
  SHORT_SHA: "${CI_COMMIT_SHA:0:8}"
  COMMIT_TAG: "sha-${SHORT_SHA}"
  VERSION_TAG: "v${CI_PIPELINE_ID}"

# Cache dependencies
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
    - $CACHE_DIR

# ---------------- Templates ---------------- #

.test_template: &test_template
  image: node:20
  stage: test
  script:
    - echo "üîç Testing: $CI_JOB_NAME"
    - npm ci
    - npm run lint || echo "‚ö†Ô∏è Lint warnings (ignored)"
    - npm test
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

.build_template: &build_template
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  script:
    - echo "üèóÔ∏è Building image for $IMAGE_NAME"
    - docker build -t $IMAGE_NAME:$COMMIT_TAG $BUILD_CONTEXT
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

.push_template: &push_template
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  script:
    - echo "üîë Login to Docker Hub..."
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    - echo "üìå Pushing commit image: $COMMIT_TAG"
    - docker push $IMAGE_NAME:$COMMIT_TAG

    - |
      if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then
        echo "üìå Tagging as latest-dev"
        docker tag $IMAGE_NAME:$COMMIT_TAG $IMAGE_NAME:latest-dev
        docker push $IMAGE_NAME:latest-dev
      fi

    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        echo "üìå Tagging as latest + $VERSION_TAG"
        docker tag $IMAGE_NAME:$COMMIT_TAG $IMAGE_NAME:latest
        docker tag $IMAGE_NAME:$COMMIT_TAG $IMAGE_NAME:$VERSION_TAG
        docker push $IMAGE_NAME:latest
        docker push $IMAGE_NAME:$VERSION_TAG
      fi
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# ---------------- Tests ---------------- #

test_frontend:
  <<: *test_template
  variables:
    CI_JOB_NAME: "Frontend"
  script:
    - cd client
    - npm ci
    - npm run lint || true
    - npm test || true

test_backend:
  <<: *test_template
  variables:
    CI_JOB_NAME: "Backend"
  script:
    - cd backend
    - npm ci
    - npm run lint || true
    - npm test || true

# ---------------- Build ---------------- #

build_frontend:
  <<: *build_template
  variables:
    IMAGE_NAME: $FRONTEND_IMAGE
    BUILD_CONTEXT: ./client

build_backend:
  <<: *build_template
  variables:
    IMAGE_NAME: $BACKEND_IMAGE
    BUILD_CONTEXT: ./backend

build_db:
  <<: *build_template
  variables:
    IMAGE_NAME: $DB_IMAGE
    BUILD_CONTEXT: ./db
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/**/*

# ---------------- Push ---------------- #

push_frontend:
  <<: *push_template
  variables:
    IMAGE_NAME: $FRONTEND_IMAGE

push_backend:
  <<: *push_template
  variables:
    IMAGE_NAME: $BACKEND_IMAGE

push_db:
  <<: *push_template
  variables:
    IMAGE_NAME: $DB_IMAGE
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/**/*

# ---------------- Deploy (optional, disabled) ---------------- #

# deploy_production:
#   stage: deploy
#   image: alpine:latest
#   script:
#     - apk add --no-cache openssh
#     - echo "üöÄ Deploying to production server via SSH..."
#     - ssh -o StrictHostKeyChecking=no user@server "
#         cd /path/to/project &&
#         docker-compose -f docker-compose.prod.yml pull &&
#         docker-compose -f docker-compose.prod.yml up -d
#       "
#   environment:
#     name: production
#     url: https://your-production-url.com
#   rules:
#     - if: '$CI_COMMIT_REF_NAME == "main"'
#       when: manual
