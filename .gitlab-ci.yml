# .gitlab-ci.yml - VERSION CORRIGÃ‰E POUR WINDOWS

stages:
  - dependencies
  - security
  - validate_test
  - build
  - deploy
  - cleanup

variables:
  DOCKER_TLS_CERTDIR: ""
  NODE_VERSION: "20"
  POSTGRES_VERSION: "15"
  NEXT_TELEMETRY_DISABLED: "1"
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"
  COMMIT_TAG: "sha-${CI_COMMIT_SHORT_SHA}"

# =============================================
# Cache Configuration - OPTIMISÃ‰
# =============================================

cache:
  key: "npm-${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
  policy: pull-push
  untracked: false
  when: on_success

.docker_build_template: &docker_build_template
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker info
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  tags:
    - windows
    - local
  timeout: 25 minutes

.node_template: &node_template
  image: node:${NODE_VERSION}
  variables:
    NPM_CONFIG_PREFER_OFFLINE: "true"
    NPM_CONFIG_AUDIT: "false"
  before_script:
    - node --version
    - npm --version
  tags:
    - windows
    - local
  timeout: 25 minutes

# =============================================
# DEPENDENCIES STAGE - OPTIMISÃ‰
# =============================================

install_all_deps:
  stage: dependencies
  <<: *node_template
  timeout: 30 minutes
  script:
    - Write-Host "ðŸ“¦ Installing dependencies (optimized)..."

    # Nettoyage conditionnel
    - |
      if (Test-Path "client/node_modules") {
        Write-Host "ðŸ§¹ Cleaning client/node_modules..."
        Remove-Item -Recurse -Force client/node_modules -ErrorAction SilentlyContinue
      }
    - |
      if (Test-Path "backend/node_modules") {
        Write-Host "ðŸ§¹ Cleaning backend/node_modules..."
        Remove-Item -Recurse -Force backend/node_modules -ErrorAction SilentlyContinue
      }

    # Installation frontend
    - cd client
    - Write-Host "ðŸ“¦ Installing frontend dependencies..."
    - npm ci --no-audit --prefer-offline
    - Write-Host "âœ… Frontend dependencies installed"
    - cd ..

    # Installation backend
    - cd backend
    - Write-Host "ðŸ“¦ Installing backend dependencies..."
    - npm ci --no-audit --prefer-offline
    - npx prisma generate --no-hints
    - Write-Host "âœ… Backend dependencies installed"
    - cd ..

    # Nettoyage des fichiers inutiles pour le cache
    - Write-Host "ðŸ§¹ Cleaning unnecessary files before cache..."
    - |
      $excludePatterns = @(
        "**/*.log",
        "**/.cache/**",
        "**/test/**",
        "**/tests/**",
        "**/__tests__/**",
        "**/coverage/**",
        "**/nyc_output/**",
        "**/.nyc_output/**",
        "**/.next/cache/**",
        "**/node_modules/.cache/**",
        "**/node_modules/.bin/**",
        "**/node_modules/*/test/**",
        "**/node_modules/*/tests/**",
        "**/node_modules/*/doc/**",
        "**/node_modules/*/docs/**"
      )

      foreach ($pattern in $excludePatterns) {
        Get-ChildItem -Path . -Recurse -Include $pattern -ErrorAction SilentlyContinue | ForEach-Object {
          Write-Host "Removing: $($_.FullName)"
          Remove-Item -Recurse -Force $_.FullName -ErrorAction SilentlyContinue
        }
      }

    - Write-Host "ðŸŽ‰ All dependencies installed successfully"
  cache:
    key: "npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - client/node_modules/
      - backend/node_modules/
    policy: pull-push
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# =============================================
# SECURITY STAGE - CORRIGÃ‰
# =============================================

security_scan:
  stage: security
  image: node:${NODE_VERSION}
  script:
    - Write-Host "ðŸ”’ Security scan..."
    - |
      if (Test-Path "client/package.json") {
        cd client
        npm audit --audit-level high --production
        cd ..
      }
    - |
      if (Test-Path "backend/package.json") {
        cd backend
        npm audit --audit-level high --production
        cd ..
      }
    - Write-Host "âœ… Security scan completed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  tags:
    - windows
    - local
  timeout: 10 minutes

# REMPLACEMENT de database_schema_validation - Version Windows compatible
database_schema_check:
  stage: security
  image: node:${NODE_VERSION}
  script:
    - Write-Host "ðŸ—„ï¸ Database schema validation (Prisma only)..."
    - cd backend
    - npx prisma validate
    # REMPLACER cette ligne problÃ©matique :
    - npx prisma db push --skip-generate
    - Write-Host "âœ… Database schema validated"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  tags:
    - windows
    - local
  timeout: 8 minutes

# =============================================
# VALIDATE + TEST STAGE
# =============================================

validate_frontend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "ðŸ” Validating frontend..."
    - cd client
    - |
      if (!(Test-Path "node_modules")) {
        Write-Host "Installing frontend dependencies..."
        npm ci --no-audit --prefer-offline --silent
      }
    - npm run build
    - Write-Host "âœ… Frontend validated"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

validate_backend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "ðŸ” Validating backend..."
    - cd backend
    - |
      if (!(Test-Path "node_modules")) {
        Write-Host "Installing backend dependencies..."
        npm ci --no-audit --prefer-offline --silent
      }
    - |
      $buildScript = npm run | Select-String "build"
      if ($buildScript) {
        npm run build --silent
      }
    - Write-Host "âœ… Backend validated"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 8 minutes

run_all_tests:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "ðŸ§ª Running tests..."

    # Frontend tests
    - cd client
    - |
      $testScript = npm run | Select-String "test"
      if ($testScript) {
        npm test -- --watchAll=false --passWithNoTests --silent
      } else {
        Write-Host "âš ï¸ No test script found in frontend"
      }
    - cd ..

    # Backend tests
    - cd backend
    - |
      $hasJest = (Test-Path "jest.config.js") -or (Test-Path "jest.config.cjs") -or (Test-Path "jest.config.ts")
      if ($hasJest) {
        npm run test -- --silent --passWithNoTests
      } else {
        Write-Host "âš ï¸ No Jest configuration found in backend"
      }
    - cd ..

    - Write-Host "âœ… All tests completed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: true  # Permettre l'Ã©chec des tests pour l'instant
  timeout: 10 minutes

# =============================================
# BUILD STAGE
# =============================================

build_frontend:
  <<: *docker_build_template
  stage: build
  script:
    - Write-Host "ðŸ—ï¸ Building frontend..."
    - docker build -t $FRONTEND_IMAGE:$COMMIT_TAG ./client
    - docker push $FRONTEND_IMAGE:$COMMIT_TAG
    - Write-Host "âœ… Frontend built and pushed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_backend:
  <<: *docker_build_template
  stage: build
  script:
    - Write-Host "ðŸ—ï¸ Building backend..."
    - docker build -t $BACKEND_IMAGE:$COMMIT_TAG ./backend
    - docker push $BACKEND_IMAGE:$COMMIT_TAG
    - Write-Host "âœ… Backend built and pushed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_database:
  <<: *docker_build_template
  stage: build
  script:
    - Write-Host "ðŸ—ï¸ Building database..."
    - docker build -t $DB_IMAGE:$COMMIT_TAG ./db
    - docker push $DB_IMAGE:$COMMIT_TAG
    - Write-Host "âœ… Database built and pushed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

# =============================================
# TEST DATABASE IMAGE
# =============================================

test_database_image:
  stage: validate_test
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - Write-Host "ðŸ—„ï¸ Testing database image..."
    - docker build -t $DB_IMAGE:test ./db
    - Write-Host "âœ… Database image tested"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  tags:
    - windows
    - local
  timeout: 8 minutes

# =============================================
# DEPLOY + CLEANUP - VERSION SIMPLIFIÃ‰E
# =============================================

deploy_staging:
  stage: deploy
  image: alpine:latest
  environment:
    name: staging
    url: https://staging.ems-platform.com
  before_script:
    - apk add --no-cache openssh-client
  script:
    - Write-Host "ðŸš€ Deploying to staging..."
    - |
      ssh -o StrictHostKeyChecking=no $STAGING_DEPLOY_USER@$STAGING_DEPLOY_SERVER "
        cd $STAGING_DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build frontend backend &&
        echo 'âœ… Staging deployment completed'"
    - Write-Host "âœ… Staging deployed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
  tags:
    - windows
    - local
  timeout: 15 minutes

deploy_production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://ems-platform.com
  before_script:
    - apk add --no-cache openssh-client curl
  script:
    - Write-Host "ðŸš€ Deploying to production..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "
        cd $DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build &&
        echo 'âœ… Production deployment completed'"
    - Write-Host "ðŸ”„ Health check..."
    - sleep 10
    - curl -f https://ems-platform.com/api/health || exit 1
    - Write-Host "âœ… Production deployed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
  tags:
    - windows
    - local
  timeout: 20 minutes

cleanup_docker:
  stage: cleanup
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - Write-Host "ðŸ§¹ Cleaning up Docker..."
    - docker system prune -f
    - Write-Host "âœ… Cleanup completed"
  tags:
    - windows
    - local
  when: always
  allow_failure: true
  timeout: 5 minutes

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'