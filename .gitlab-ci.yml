stages:
  - test
  - build
  - push
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  CACHE_DIR: "$CI_PROJECT_DIR/.cache"
  FRONTEND_IMAGE: "amineelalami/ems-platform:frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform:backend"
  DB_IMAGE: "amineelalami/ems-platform:db"
  SHORT_SHA: "${CI_COMMIT_SHA:0:8}"
  TIMESTAMP: "$(date +%Y%m%d%H%M%S)"
  COMMIT_TAG: "sha-${SHORT_SHA}-${TIMESTAMP}"
  VERSION_TAG: "v${CI_PIPELINE_ID}"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
    - $CACHE_DIR

# ----------- Templates -----------
.test_template: &test_template
  image: node:20
  stage: test
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  script:
    - cd $APP_DIR
    - npm ci
    - npm run lint || true
    - npm test || true

.build_template: &build_template
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  script:
    - export SHORT_SHA=${CI_COMMIT_SHA:0:8}
    - export TIMESTAMP=$(date +%Y%m%d%H%M%S)
    - export COMMIT_TAG="sha-${SHORT_SHA}-${TIMESTAMP}"
    - echo "üèóÔ∏è Building $IMAGE_NAME:$COMMIT_TAG"
    - docker build -t "$IMAGE_NAME:$COMMIT_TAG" "$BUILD_CONTEXT"

.push_template: &push_template
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  script:
    - echo "üîë Checking Docker Hub credentials..."
    - if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ]; then echo "ERREUR : DOCKERHUB_USERNAME ou DOCKERHUB_TOKEN manquant !"; exit 1; fi
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "üìå Pushing $IMAGE_NAME:$CI_COMMIT_REF_NAME"
    - docker tag "$IMAGE_NAME:$COMMIT_TAG" "$IMAGE_NAME:$CI_COMMIT_REF_NAME"
    - docker push "$IMAGE_NAME:$CI_COMMIT_REF_NAME"
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then echo "üìå Tagging $IMAGE_NAME as $VERSION_TAG and latest for production"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$IMAGE_NAME:$COMMIT_TAG" "$IMAGE_NAME:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker tag "$IMAGE_NAME:$COMMIT_TAG" "$IMAGE_NAME:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$IMAGE_NAME:$VERSION_TAG"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then docker push "$IMAGE_NAME:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then echo "üìå Tagging $IMAGE_NAME as latest for development"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker tag "$IMAGE_NAME:$COMMIT_TAG" "$IMAGE_NAME:latest"; fi
    - if [ "$CI_COMMIT_REF_NAME" = "dev" ]; then docker push "$IMAGE_NAME:latest"; fi

# ----------- Jobs -----------
test_frontend:
  <<: *test_template
  variables:
    APP_DIR: client

test_backend:
  <<: *test_template
  variables:
    APP_DIR: backend

build_frontend:
  <<: *build_template
  variables:
    IMAGE_NAME: $FRONTEND_IMAGE
    BUILD_CONTEXT: ./client

build_backend:
  <<: *build_template
  variables:
    IMAGE_NAME: $BACKEND_IMAGE
    BUILD_CONTEXT: ./backend

build_db:
  <<: *build_template
  variables:
    IMAGE_NAME: $DB_IMAGE
    BUILD_CONTEXT: ./db
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/Dockerfile
        - db/**/*

push_frontend:
  <<: *push_template
  variables:
    IMAGE_NAME: $FRONTEND_IMAGE
  needs: ["build_frontend"]

push_backend:
  <<: *push_template
  variables:
    IMAGE_NAME: $BACKEND_IMAGE
  needs: ["build_backend"]

push_db:
  <<: *push_template
  variables:
    IMAGE_NAME: $DB_IMAGE
  needs: ["build_db"]
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
      changes:
        - db/Dockerfile
        - db/**/*

deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache openssh-client
    - ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
        cd /path/to/project &&
        export TAG=latest &&
        docker-compose -f docker-compose.prod.yml pull &&
        docker-compose -f docker-compose.prod.yml up -d
      "
  environment: production
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual