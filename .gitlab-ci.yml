stages:
  - test
  - build
  - push
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""

  # Images Docker
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"

  # Tags
  COMMIT_TAG: "sha-${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_ID}"
  VERSION_TAG: "v${CI_PIPELINE_ID}"

# ----------- Cache -----------
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - client/node_modules/
    - backend/node_modules/
  policy: pull-push

# ----------- Jobs -----------

test_frontend:
  image: node:20
  stage: test
  before_script:
    - cd client
    - npm ci
  script:
    - echo "üîç Running frontend tests..."
    - npm run lint || echo "‚ö†Ô∏è  Lint skipped or failed"
    - npm test || echo "‚ö†Ô∏è  Tests skipped or failed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

test_backend:
  image: node:20
  stage: test
  before_script:
    - cd backend
    - npm ci
  script:
    - echo "üîç Running backend tests..."
    - npm run lint || echo "‚ö†Ô∏è  Lint skipped or failed"
    - npm test || echo "‚ö†Ô∏è  Tests skipped or failed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

test_db:
  image: docker:24
  stage: test
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    POSTGRES_DB: "employeedb"
  before_script:
    - apk add --no-cache postgresql-client git
    - docker info
    - git fetch origin dump
    - git show origin/dump:db/employeedb_dump_pg15.sql > db/employeedb_dump_pg15.sql
    - ls -la db/employeedb_dump_pg15.sql
  script:
    - echo "üîç Testing database setup..."
    - ls -la db/
    - test -f "db/employeedb_dump_pg15.sql" && echo "‚úÖ SQL file exists" || echo "‚ùå SQL file missing"
    - docker build -t $DB_IMAGE:test ./db
    - echo "‚úÖ Database image built successfully"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_frontend:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info
  script:
    - echo "üèóÔ∏è Building frontend image..."
    - docker build -t $FRONTEND_IMAGE:$COMMIT_TAG -t $FRONTEND_IMAGE:latest ./client
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_backend:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info
  script:
    - echo "üèóÔ∏è Building backend image..."
    - docker build -t $BACKEND_IMAGE:$COMMIT_TAG -t $BACKEND_IMAGE:latest ./backend
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

build_db:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info
    - apk add --no-cache git
    - git fetch origin dump
    - git show origin/dump:db/employeedb_dump_pg15.sql > db/employeedb_dump_pg15.sql
    - ls -la db/employeedb_dump_pg15.sql
  script:
    - echo "üèóÔ∏è Building database image..."
    - docker build -t $DB_IMAGE:$COMMIT_TAG -t $DB_IMAGE:latest ./db
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

push_frontend:
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "üìå Pushing frontend image..."
    - docker push $FRONTEND_IMAGE:$COMMIT_TAG
    - docker push $FRONTEND_IMAGE:latest
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $FRONTEND_IMAGE:$COMMIT_TAG $FRONTEND_IMAGE:$VERSION_TAG;
        docker push $FRONTEND_IMAGE:$VERSION_TAG;
      fi
  dependencies:
    - build_frontend
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

push_backend:
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "üìå Pushing backend image..."
    - docker push $BACKEND_IMAGE:$COMMIT_TAG
    - docker push $BACKEND_IMAGE:latest
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $BACKEND_IMAGE:$COMMIT_TAG $BACKEND_IMAGE:$VERSION_TAG;
        docker push $BACKEND_IMAGE:$VERSION_TAG;
      fi
  dependencies:
    - build_backend
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

push_db:
  image: docker:24
  stage: push
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "üìå Pushing database image..."
    - docker push $DB_IMAGE:$COMMIT_TAG
    - docker push $DB_IMAGE:latest
    - if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag $DB_IMAGE:$COMMIT_TAG $DB_IMAGE:$VERSION_TAG;
        docker push $DB_IMAGE:$VERSION_TAG;
      fi
  dependencies:
    - build_db
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'

deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache openssh-client
    - echo "üöÄ Deploying to production server..."
    - 'ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "cd $DEPLOY_PATH && docker-compose pull && docker-compose up -d"'
  environment:
    name: production
    url: https://your-production-url.com
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual