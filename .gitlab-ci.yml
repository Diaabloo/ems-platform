stages:
  - dependencies
  - security
  - validate_test
  - build
  - deploy
  - clean

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: "1"
  NODE_VERSION: "20"
  POSTGRES_VERSION: "15"
  NEXT_TELEMETRY_DISABLED: "1"
  NPM_CONFIG_PREFER_OFFLINE: "true"
  NPM_CONFIG_AUDIT: "false"
  FRONTEND_IMAGE: "amineelalami/ems-platform-frontend"
  BACKEND_IMAGE: "amineelalami/ems-platform-backend"
  DB_IMAGE: "amineelalami/ems-platform-db"
  COMMIT_TAG: "sha-${CI_COMMIT_SHORT_SHA}"

# =============================================
# TEMPLATES PROFESSIONNELS
# =============================================

.docker_template: &docker_template
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_BUILDKIT: "1"
  before_script:
    - docker info
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  tags:
    - project-runner    # Runner d√©di√© au projet
    - docker           # Ex√©cution Docker
    - windows          # Environnement Windows
    - ems-platform     # Application sp√©cifique

.node_template: &node_template
  image: node:${NODE_VERSION}
  before_script:
    - node --version
    - npm --version
  tags:
    - project-runner
    - docker
    - windows
    - ems-platform

.alpine_template: &alpine_template
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
  tags:
    - project-runner
    - docker
    - windows
    - ems-platform

# =============================================
# JOBS - STRUCTURE PROFESSIONNELLE
# =============================================

# D√âPENDANCES
install_frontend_deps:
  stage: dependencies
  <<: *node_template
  script:
    - Write-Host "üì¶ Installing Frontend dependencies..."
    - cd client
    - Write-Host "üîç Checking for existing node_modules..."
    - |
      if (Test-Path "node_modules") {
        Write-Host "üîÑ node_modules found, using cache..."
        npm install --prefer-offline --no-audit
        Write-Host "‚úÖ Frontend dependencies updated from cache"
      } else {
        Write-Host "üì• Full installation (no cache found)..."
        npm install --prefer-offline --no-audit
        Write-Host "‚úÖ Frontend dependencies installed"
      }
  cache:
    key: "frontend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - client/node_modules/
    policy: pull-push
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

install_backend_deps:
  stage: dependencies
  <<: *node_template
  before_script:
    - node --version
    - npm --version
    - Write-Host "üîß Setting up DATABASE_URL for Prisma..."
    - $env:DATABASE_URL = "postgresql://$($env:POSTGRES_USER):$($env:POSTGRES_PASSWORD)@localhost:5432/$($env:POSTGRES_DB)"
    - Write-Host "‚úÖ DATABASE_URL configured (using GitLab variables)"
  script:
    - Write-Host "üì¶ Installing Backend dependencies..."
    - cd backend
    - Write-Host "üîç Checking for existing node_modules..."
    - |
      if (Test-Path "node_modules") {
        Write-Host "üîÑ node_modules found, using cache..."
        npm install --prefer-offline --no-audit
        Write-Host "‚úÖ Backend dependencies updated from cache"
      } else {
        Write-Host "üì• Full installation (no cache found)..."
        npm install --prefer-offline --no-audit
        Write-Host "‚úÖ Backend dependencies installed"
      }
    - Write-Host "üóÑÔ∏è Generating Prisma client..."
    - npx prisma generate --no-hints
    - Write-Host "‚úÖ Prisma client generated successfully"
  cache:
    key: "backend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/node_modules/
      - backend/node_modules/.prisma/
      - backend/node_modules/@prisma/
    policy: pull-push
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

# S√âCURIT√â
audit_frontend:
  stage: security
  <<: *node_template
  script:
    - Write-Host "üîí Frontend security audit..."
    - cd client
    - npm audit --audit-level high --production
    - Write-Host "‚úÖ Frontend audit completed"
  cache:
    key: "frontend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - client/node_modules/
    policy: pull
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 10 minutes

audit_backend:
  stage: security
  <<: *node_template
  script:
    - Write-Host "üîí Backend security audit..."
    - cd backend
    - npm audit --audit-level high --production
    - Write-Host "‚úÖ Backend audit completed"
  cache:
    key: "backend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/node_modules/
    policy: pull
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 10 minutes

validate_prisma_schema:
  stage: security
  <<: *node_template
  before_script:
    - node --version
    - npm --version
    - Write-Host "üîß Setting up DATABASE_URL for Prisma validation..."
    - $env:DATABASE_URL = "postgresql://$($env:POSTGRES_USER):$($env:POSTGRES_PASSWORD)@localhost:5432/$($env:POSTGRES_DB)"
    - Write-Host "‚úÖ DATABASE_URL configured for validation"
  script:
    - Write-Host "üóÑÔ∏è Prisma schema validation..."
    - cd backend
    - Write-Host "üìã Prisma schema content (first 10 lines):"
    - Get-Content prisma/schema.prisma | Select-Object -First 10
    - npx prisma validate
    - Write-Host "‚úÖ Prisma schema validated"
  cache:
    key: "backend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/node_modules/
    policy: pull
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

# VALIDATION & TESTS
validate_frontend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üîç Frontend build validation..."
    - cd client
    - npm run build
    - Write-Host "‚úÖ Frontend validated successfully"
  cache:
    key: "frontend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - client/node_modules/
    policy: pull
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

validate_backend:
  stage: validate_test
  <<: *node_template
  before_script:
    - node --version
    - npm --version
    - Write-Host "üîß Setting up DATABASE_URL for Backend validation..."
    - $env:DATABASE_URL = "postgresql://$($env:POSTGRES_USER):$($env:POSTGRES_PASSWORD)@localhost:5432/$($env:POSTGRES_DB)"
  script:
    - Write-Host "üîç Backend validation..."
    - cd backend
    - Write-Host "üîç Checking project structure..."
    - |
      # V√©rifier si c'est un projet TypeScript ou JavaScript
      $tsFiles = Get-ChildItem -Recurse -Filter "*.ts" | Measure-Object
      $tsConfig = Test-Path "tsconfig.json"

      if ($tsConfig -or $tsFiles.Count -gt 0) {
        Write-Host "‚úÖ TypeScript project detected - running type check..."
        npm run type-check
        Write-Host "‚úÖ TypeScript validation passed"
      } else {
        Write-Host "‚úÖ JavaScript project - no TypeScript files to check"
        Write-Host "üîç Running syntax validation on JavaScript files..."
        # Valider la syntaxe des fichiers JS principaux
        if (Test-Path "index.js") {
          node -c index.js
          Write-Host "‚úÖ index.js syntax is valid"
        }
        if (Test-Path "src" -and (Test-Path "src/index.js")) {
          node -c src/index.js
          Write-Host "‚úÖ src/index.js syntax is valid"
        }
        Write-Host "üéâ JavaScript project validation completed"
      }
    - Write-Host "‚úÖ Backend validation completed successfully"
  cache:
    key: "backend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/node_modules/
    policy: pull
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

test_frontend:
  stage: validate_test
  <<: *node_template
  script:
    - Write-Host "üß™ Running Frontend tests..."
    - cd client
    - |
      if (Test-Path "package.json") {
        $testScript = npm run | Select-String "test"
        if ($testScript) {
          npm test -- --watchAll=false --passWithNoTests --silent
          Write-Host "‚úÖ Frontend tests completed"
        } else {
          Write-Host "‚ö†Ô∏è No test script found in Frontend"
        }
      }
  cache:
    key: "frontend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - client/node_modules/
    policy: pull
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 10 minutes

test_backend:
  stage: validate_test
  <<: *node_template
  before_script:
    - node --version
    - npm --version
    - Write-Host "üîß Setting up DATABASE_URL for Backend tests..."
    - $env:DATABASE_URL = "postgresql://$($env:POSTGRES_USER):$($env:POSTGRES_PASSWORD)@localhost:5432/$($env:POSTGRES_DB)"
  script:
    - Write-Host "üß™ Running Backend tests..."
    - cd backend
    - npm run test:ci
    - Write-Host "‚úÖ Backend tests completed"
  cache:
    key: "backend-npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/node_modules/
    policy: pull
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  allow_failure: true
  timeout: 10 minutes

# BUILD
build_frontend_image:
  stage: build
  <<: *docker_template
  script:
    - Write-Host "üèóÔ∏è Building Frontend image..."
    - docker build -t $FRONTEND_IMAGE:$COMMIT_TAG ./client
    - |
      if ($env:CI_COMMIT_REF_NAME -eq "main") {
        Write-Host "üöÄ Pushing Frontend image to Docker Hub..."
        docker push $FRONTEND_IMAGE:$COMMIT_TAG
      } else {
        Write-Host "‚è≠Ô∏è Push skipped (dev branch - pre-production)"
      }
    - Write-Host "‚úÖ Frontend image built"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 15 minutes

build_backend_image:
  stage: build
  <<: *docker_template
  script:
    - Write-Host "üèóÔ∏è Building Backend image..."
    - docker build -t $BACKEND_IMAGE:$COMMIT_TAG ./backend
    - |
      if ($env:CI_COMMIT_REF_NAME -eq "main") {
        Write-Host "üöÄ Pushing Backend image to Docker Hub..."
        docker push $BACKEND_IMAGE:$COMMIT_TAG
      } else {
        Write-Host "‚è≠Ô∏è Push skipped (dev branch - pre-production)"
      }
    - Write-Host "‚úÖ Backend image built"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 15 minutes

build_db_image:
  stage: build
  <<: *docker_template
  script:
    - Write-Host "üèóÔ∏è Building Database image..."
    - docker build -t $DB_IMAGE:$COMMIT_TAG ./db
    - |
      if ($env:CI_COMMIT_REF_NAME -eq "main") {
        Write-Host "üöÄ Pushing Database image to Docker Hub..."
        docker push $DB_IMAGE:$COMMIT_TAG
      } else {
        Write-Host "‚è≠Ô∏è Push skipped (dev branch - pre-production)"
      }
    - Write-Host "‚úÖ Database image built"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev" || $CI_COMMIT_REF_NAME == "main"'
  timeout: 10 minutes

# D√âPLOIEMENT
deploy_staging:
  stage: deploy
  <<: *alpine_template
  environment:
    name: staging
    url: https://staging.ems-platform.com
  script:
    - Write-Host "üöÄ AUTO Deploying to pre-production..."
    - |
      ssh -o StrictHostKeyChecking=no $STAGING_DEPLOY_USER@$STAGING_DEPLOY_SERVER "
        cd $STAGING_DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build &&
        echo '‚úÖ Pre-production deployed successfully'"
    - Write-Host "‚úÖ Pre-production deployment completed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
  timeout: 10 minutes

deploy_production:
  stage: deploy
  <<: *alpine_template
  environment:
    name: production
    url: https://ems-platform.com
  script:
    - Write-Host "üöÄ MANUAL Deploying to production..."
    - |
      ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "
        cd $DEPLOY_PATH &&
        docker-compose pull --quiet &&
        docker-compose up -d --no-build &&
        echo '‚úÖ Production deployed successfully'"
    - Write-Host "üîÑ Health check..."
    - sleep 10
    - curl -f https://ems-platform.com/api/health || exit 1
    - Write-Host "‚úÖ Production deployment completed"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
  timeout: 15 minutes

# NETTOYAGE
cleanup_docker:
  stage: clean
  <<: *docker_template
  script:
    - Write-Host "üßπ Docker cleanup..."
    - docker system prune -f
    - Write-Host "‚úÖ Cleanup completed"
  when: always
  allow_failure: true
  timeout: 10 minutes

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'